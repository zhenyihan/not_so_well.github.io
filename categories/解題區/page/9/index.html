<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: 解題區 | Morris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Morris' Blog">
<meta property="og:url" content="http://morris821028.github.io/categories/解題區/page/9/index.html">
<meta property="og:site_name" content="Morris' Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Morris' Blog">
<meta name="twitter:description">
<link rel="publisher" href="108158678174364350000">
  
    <link rel="alternative" href="/atom.xml" title="Morris&#39; Blog" type="application/atom+xml">
  
  
    <meta name="google-site-verification" content="5mRgj8NanEMpGZuNfHNJNmH90RgNlrnJXsFlTaKD6Gs" />
  
  
    <link rel="shortcut icon" href="/img/f.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <script src="/js/jquery-2.1.0.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  
  <link rel="stylesheet" href="http://cdn.oesmith.co.uk/morris-0.5.1.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="http://cdn.oesmith.co.uk/morris-0.5.1.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"><div id="banner-right"></div></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Morris&#39; Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          
            <a class="main-nav-link" href="/"><i class=icon-home title='Home'></i></a>
          
        
          
            <a class="main-nav-link" href="/about"><i class=icon-user title='About'></i></a>
          
        
          
            <a class="main-nav-link" href="/archives"><i class=icon-archive title='Archives'></i></a>
          
        
          
            <a class="main-nav-link" href="/tags"><i class=icon-tags title='Tags'></i></a>
          
        
          
            <a class="main-nav-link" href="/picture"><i class=icon-camera title='Pictures'></i></a>
          
        
          
            <a class="main-nav-link" href="/works"><i class=icon-trophy title='Works'></i></a>
          
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://morris821028.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        
          <section id="main">
  
    <article id="post-zj-d476" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/25/zj-d476/" class="article-date">
  <time datetime="2015-06-24T23:05:28.000Z" itemprop="datePublished">2015-06-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/25/zj-d476/">d476. 區間查詢</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/25/zj-d476/" data-id="cimun1kox00xen2xcjrm2uh9m" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/25/zj-d476/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/整體二分/">整體二分</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>一個長度為 n 的序列，支持兩種操作：</p>
<ol>
<li>输出 $[A, B]$ 區間第 k 小的數 (從小到大排序後第 k 個)</li>
<li>修改第 I 個數為 W</li>
</ol>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5 3</span><br><span class="line">1 2 3 4 5</span><br><span class="line">Q 1 4 2</span><br><span class="line">C 2 5</span><br><span class="line">Q 1 4 2</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在討論用一些雜七雜八的樹類結構去跟莫隊算法搏鬥之餘，用了轉幾何方向去兜資料結構，隨後發現題目尋找的是 unique 而非計數，因此很多想法就垮台，當然出成另一道題目也是不錯。決定尋找其他想法！</p>
<h3 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h3><p>整體二分是什麼呢？假設操作只有修改、詢問，不包含插入、刪除，而且詢問是一個數值結果，這個數值結果可以藉由二分 + 掃描來完成，那就可以使用整體二分來離線支持。</p>
<p>對答案值域分治，將相關操作分治在一起，同時要保留順序性，分治過程中會不斷地累加每一個詢問的掃描數值，最後滿溢時紀錄答案。每一個操作最多在 $\log \text{MAXV}$ 層計算，因此複雜度是 $O(Q \log \text{MAXV})$。</p>
<p>好處是可以用常數較低的結構，所以會比較快？</p>
<h4 id="應用"><a href="#應用" class="headerlink" title="應用"></a>應用</h4><p>這一道經典題有很多作法，如持久化線段樹、塊狀鏈表、歸併樹、劃分樹、 … 等。其中能支持修改的有塊狀鏈表、複雜的持久化線段樹 (主席樹)。</p>
<p>帶修改的區間 K 小，概略說明二分答案 $x$，然後去查找小於等於 $x$ 的數字在區間 $[l, r]$ 內出現的次數是否大於等於 $K$。然後修改元素有加入跟移除，二分答案 mid，要將加入、移除會影響的 $A[i] \le mid$，加入或移除時對該數字的索引值 $i$ 建造統計方案。</p>
<p>對於(位置, 值) $\left \langle i, A[i] \right \rangle$ 來說，一開始的前 $N$ 個操作是加入 $\left \langle i, A[i] \right \rangle$，二分答案時，用一個 binary indexed tree 去維護 index 的個數，也就是說，對於修改元素 $\left \langle i, A[i] \right \rangle$ 相當於在二分答案 mid 時，插入 <code>BIT.add(i, 1)</code>，那對於區間詢問，相當於查找 <code>BIT.query([l, r])</code> 如此一來就能知道區間 $[l, r]$ 在 mid 以內有幾個數字符合。</p>
<p>假設計數大於 k，詢問往左放，反之扣除已知 mid 以內的數量，詢問往右放，如此一來就完成了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">65536</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">0x3f3f3f3f</span>;</span><br><span class="line"><span class="keyword">class</span> Offline &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Event &#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, k, qtype, qid;</span><br><span class="line">        <span class="keyword">int</span> calc; <span class="comment">//</span></span><br><span class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>, <span class="keyword">int</span> d = <span class="number">0</span>, <span class="keyword">int</span> e = <span class="number">0</span>, <span class="keyword">int</span> f = <span class="number">0</span>):</span><br><span class="line">            x(a), y(b), k(c), qtype(d), qid(e), calc(f) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Event&gt; event;</span><br><span class="line">    <span class="keyword">int</span> N, ret[MAXQ];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;N = N;</span><br><span class="line">        event.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addEvent</span><span class="params">(<span class="keyword">int</span> qtype, <span class="keyword">int</span> qid, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        event.push_back(Event(x, y, k, qtype, qid));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DC(<span class="number">0</span>, event.size()<span class="number">-1</span>, <span class="number">0</span>, INF);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// buffer</span></span><br><span class="line">    <span class="keyword">int</span> buf[MAXQ];</span><br><span class="line">    Event ebuf1[MAXQ], ebuf2[MAXQ];</span><br><span class="line">    <span class="comment">// binary indexed tree</span></span><br><span class="line">    <span class="keyword">int</span> bit[MAXN];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (x &lt;= N) &#123;</span><br><span class="line">            bit[x] += val;</span><br><span class="line">            x += (x)&amp;(-x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (x) &#123;</span><br><span class="line">            ret += bit[x];</span><br><span class="line">            x -= (x)&amp;(-x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DC</span><span class="params">(<span class="keyword">int</span> q_l, <span class="keyword">int</span> q_r, <span class="keyword">int</span> val_l, <span class="keyword">int</span> val_r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (q_l &gt; q_r)	<span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">if</span> (val_l == val_r) &#123;	<span class="comment">// find</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++)</span><br><span class="line">                <span class="keyword">if</span> (event[i].qtype == <span class="number">2</span>)</span><br><span class="line">                    ret[event[i].qid] = val_l;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (val_l + val_r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> &amp;&amp; event[i].y &lt;= mid)</span><br><span class="line">                add(event[i].x, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">1</span> &amp;&amp; event[i].y &lt;= mid)</span><br><span class="line">                add(event[i].x, <span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">2</span>)</span><br><span class="line">                buf[i] = query(event[i].y) - query(event[i].x<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123; <span class="comment">// resume</span></span><br><span class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> &amp;&amp; event[i].y &lt;= mid)</span><br><span class="line">                add(event[i].x, <span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (event[i].qtype == <span class="number">1</span> &amp;&amp; event[i].y &lt;= mid)</span><br><span class="line">                add(event[i].x, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> lidx = <span class="number">0</span>, ridx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = q_l; i &lt;= q_r; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (event[i].qtype == <span class="number">0</span> || event[i].qtype == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (event[i].y &lt;= mid)</span><br><span class="line">                    ebuf1[lidx++] = event[i];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ebuf2[ridx++] = event[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event[i].calc + buf[i] &gt; event[i].k - <span class="number">1</span>)</span><br><span class="line">                    ebuf1[lidx++] = event[i];</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    event[i].calc += buf[i];</span><br><span class="line">                    ebuf2[ridx++] = event[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lidx; i++)</span><br><span class="line">            event[q_l+i] = ebuf1[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ridx; i++)</span><br><span class="line">            event[q_l+lidx+i] = ebuf2[i];</span><br><span class="line">        DC(q_l, q_l+lidx<span class="number">-1</span>, val_l, mid);</span><br><span class="line">        DC(q_l+lidx, q_r, mid+<span class="number">1</span>, val_r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; off;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m, x, y, k, v;</span><br><span class="line">    <span class="keyword">int</span> A[<span class="number">65536</span>];</span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        off.init(n);</span><br><span class="line">        <span class="comment">// qtype 0:add, 1:remove, 2: query</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</span><br><span class="line">            off.addEvent(<span class="number">0</span>, <span class="number">0</span>, i, A[i], <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> qid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">'Q'</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;x, &amp;y, &amp;k);</span><br><span class="line">                off.addEvent(<span class="number">2</span>, qid++, x, y, k);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</span><br><span class="line">                off.addEvent(<span class="number">1</span>, <span class="number">0</span>, x, A[x], <span class="number">0</span>);</span><br><span class="line">                off.addEvent(<span class="number">0</span>, <span class="number">0</span>, x, v, <span class="number">0</span>);</span><br><span class="line">                A[x] = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        off.run();		</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; qid; i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, off.ret[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-TIOJ-1475" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/22/TIOJ-1475/" class="article-date">
  <time datetime="2015-06-22T01:24:23.000Z" itemprop="datePublished">2015-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/22/TIOJ-1475/">TIOJ 1475 錄製專輯 (Record)</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/22/TIOJ-1475/" data-id="cimun1k2d000hn2xct7e8yikt" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/22/TIOJ-1475/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dp/">dp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大數/">大數</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Jolin 是個愛唱歌的小孩，每次總喜歡邊唱邊用電腦把自己的歌聲錄下來，因此長久下來，在她的電腦裡，已儲存了為數不小的個人歌唱作品。由於耶誕節快要到了，為了準備一份特別的耶誕禮物給爸爸，Jolin 準備從電腦中儲存的個人歌唱作品，挑選幾首歌製成一張個人專輯 CD。由於每張 CD 的容量有限，而Jolin 的個人歌唱作品早已遠遠超過一張 CD 可收錄的容量，因此 Jolin 希望你可以幫她想辦法，讓她所製作的專輯中，能有數目最多的歌曲（請注意：每一首歌只能被收錄一次），同時必需剛好裝滿整張 CD，不留下任何未使用的空間。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">10 50 30 70 60</span><br><span class="line">80 </span><br><span class="line">5</span><br><span class="line">10 50 30 70 60</span><br><span class="line">20</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 4</span><br><span class="line">0 0</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>實作 C++ 簡單的加法、乘法大數，直接把別提的拿過來用。</p>
<p>套用 0/1 背包問題，額外增加大數紀錄方法數，最後乘上 $N!$ 即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> BigInteger &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; v;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> MAXC;</span><br><span class="line">    BigInteger(<span class="keyword">int</span> x = <span class="number">0</span>) &#123;</span><br><span class="line">        v = <span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;(<span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">        v[<span class="number">0</span>] = x;</span><br><span class="line">        MAXC = <span class="number">100000000</span>;</span><br><span class="line">        normal();</span><br><span class="line">    &#125;</span><br><span class="line">    BigInteger <span class="keyword">operator</span>+(<span class="keyword">const</span> BigInteger &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="function">BigInteger <span class="title">r</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">        r.v.resize(max(v.size(), x.v.size()) + <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.size(); i++)</span><br><span class="line">            r.v[i] += v[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; x.v.size(); i++)</span><br><span class="line">            r.v[i] += x.v[i];</span><br><span class="line">        r.normal();</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    BigInteger <span class="keyword">operator</span>*(<span class="keyword">const</span> BigInteger &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="function">BigInteger <span class="title">r</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">        r.v.resize(v.size() + x.v.size() + <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v[i] == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; x.v.size(); j++)</span><br><span class="line">                r.v[i+j] += v[i] * x.v[j];</span><br><span class="line">        &#125;</span><br><span class="line">        r.normal();</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">normal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v[i] &gt;= MAXC) &#123;</span><br><span class="line">                v[i+<span class="number">1</span>] += v[i] / MAXC;</span><br><span class="line">                v[i] %= MAXC;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> s = (<span class="keyword">int</span>) v.size() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (s &gt; <span class="number">0</span> &amp;&amp; v[s] == <span class="number">0</span>)</span><br><span class="line">            s--;</span><br><span class="line">        v.resize(s+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isZero</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v.size() &gt; <span class="number">1</span>)   <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> v[<span class="number">0</span>] == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> BigInteger &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">    	<span class="keyword">if</span> (v.size() != x.v.size())</span><br><span class="line">    		<span class="keyword">return</span> v.size() &lt; x.v.size();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = v.size()<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    		<span class="keyword">if</span> (v[i] != x.v[i])</span><br><span class="line">    			<span class="keyword">return</span> v[i] &lt; x.v[i];</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> BigInteger &amp;x)  <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (v.size() != x.v.size())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = v.size()<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            <span class="keyword">if</span> (v[i] != x.v[i])</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%lld"</span>, v[v.size()<span class="number">-1</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) v.size() - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%08lld"</span>, v[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, M, A[<span class="number">128</span>];</span><br><span class="line">    BigInteger f[<span class="number">128</span>] = &#123;&#125;;</span><br><span class="line">    f[<span class="number">0</span>] = BigInteger(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">128</span>; i++)</span><br><span class="line">        f[i] = f[i<span class="number">-1</span>] * BigInteger(i);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;M);</span><br><span class="line">        </span><br><span class="line">        sort(A, A + N);</span><br><span class="line">        <span class="keyword">int</span> dp[<span class="number">10005</span>] = &#123;&#125;;</span><br><span class="line">        BigInteger dp2[<span class="number">10005</span>] = &#123;&#125;;</span><br><span class="line">        dp2[<span class="number">0</span>] = BigInteger(<span class="number">1</span>), dp[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> x = A[i];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = M; j &gt;= x; j--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dp[j] &lt; dp[j-x] + <span class="number">1</span> &amp;&amp; !dp2[j-x].isZero())</span><br><span class="line">                    dp[j] = dp[j-x] + <span class="number">1</span>, dp2[j] = BigInteger(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (dp[j] == dp[j-x] + <span class="number">1</span> &amp;&amp; !dp2[j-x].isZero())</span><br><span class="line">                    dp2[j] = dp2[j] + dp2[j-x];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> a = dp[M];</span><br><span class="line">        BigInteger b = dp2[M] * f[a];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d "</span>, a);</span><br><span class="line">        b.print();</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">5</span><br><span class="line">10 50 30 70 60</span><br><span class="line">20 </span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-bzoj-2038" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/22/bzoj-2038/" class="article-date">
  <time datetime="2015-06-22T01:05:47.000Z" itemprop="datePublished">2015-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/22/bzoj-2038/">BZOJ 2038 小 Z 的袜子</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/22/bzoj-2038/" data-id="cimun1k3a000zn2xce068xmbc" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/22/bzoj-2038/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/莫隊算法/">莫隊算法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/離線處理/">離線處理</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一個序列，詢問一個區間中任挑兩個數字，這兩個數字相同的機率為何，將答案化簡後輸出。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">6 4</span><br><span class="line">1 2 3 3 3 2</span><br><span class="line">2 6</span><br><span class="line">1 3</span><br><span class="line">3 5</span><br><span class="line">1 6</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2/5</span><br><span class="line">0/1</span><br><span class="line">1/1</span><br><span class="line">4/15</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>莫隊算法命名是莫濤隊伍想出來的，不算是特別算法命名，估計是比賽中想到，目前沒看到英文命名。</p>
<p>莫隊算法處理離線詢問，回答所有答案複雜度為 $O(N^{1.5})$，其中 N 是區間索引值的範圍大小。概念在於分塊處理如下：</p>
<ul>
<li>對於每個詢問的左端點放置於同一塊去處理</li>
<li>每一次處理一個塊狀的所有詢問</li>
<li>對於同一塊，詢問的右端點嚴格遞增去處理，讓左端點不斷地移動</li>
</ul>
<p>發現到單獨看左端點指針的移動，約為 $O(N^{1.5})$，只考慮同一塊，最多有 $N$ 的詢問，一個詢問會造成左端點移動 $O(N^{0.5})$。而單獨看又端點指針的移動，約為 $O(N^{1.5})$，由於只會有 $O(N^{0.5})$ 塊，每一塊最慘就是遞增的移動 $O(N)$。</p>
<p>只要轉移區間 (維護區間的答案、計數，例如從 <code>[l, r]</code> 變成 <code>[l, r-1]</code> 的答案維護，把區間左右端點變大變小 1 的轉移計算) 的速度快，則複雜度約為 $O(N^{1.5})$。有不少情況需要 $O(\log N)$ 的其他數據結構維護轉移，複雜度就會變成 $O(N^{1.5} \log N)$，必要時使用塊狀表去作為數據結構進行轉移，當詢問次數 Q 與序列長度 N 呈線性關係，塊狀表支持 $O(1)$ 修改，$O(N^{0.5})$ 統計，那複雜度又能壓回 $O(N^{1.5})$。</p>
<p>能使用莫隊算法的題目，其中也不少能使用持久化結構來完成，若不考慮空間使用量，持久化結構能支持離線預處理、在線詢問。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">50005</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXV = <span class="number">50005</span>;</span><br><span class="line"><span class="keyword">class</span> Offline &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Event &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> PILE;</span><br><span class="line">        <span class="keyword">int</span> l, r, qid;</span><br><span class="line">        Event(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span>, <span class="keyword">int</span> c = <span class="number">0</span>):</span><br><span class="line">            l(a), r(b), qid(c) &#123;&#125;</span><br><span class="line">        <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Event &amp;x) <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (l / PILE != x.l / PILE)</span><br><span class="line">                <span class="keyword">return</span> l &lt; x.l;</span><br><span class="line">            <span class="keyword">return</span> r &lt; x.r; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> A[MAXN], N, qsize;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Event&gt; event;</span><br><span class="line">    <span class="built_in">vector</span>&lt; pair&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">long</span> <span class="keyword">long</span>&gt; &gt; ret;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;N = N, qsize = <span class="number">0</span>;</span><br><span class="line">        event.clear();</span><br><span class="line">        <span class="built_in">memset</span>(B, <span class="number">0</span>, <span class="keyword">sizeof</span>(B));</span><br><span class="line">        <span class="keyword">for</span> (Event::PILE = <span class="number">1</span>; Event::PILE * Event::PILE &lt; N; Event::PILE &lt;&lt;= <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_add</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        event.push_back(Event(l, r, qsize));</span><br><span class="line">        qsize++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sort(event.begin(), event.end());</span><br><span class="line">        ret.resize(event.size());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">1</span>, r = <span class="number">0</span>;</span><br><span class="line">        q_stat = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; event.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (r &lt; event[i].r)	r++, update(A[r], <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">while</span> (r &gt; event[i].r)	update(A[r], <span class="number">-1</span>), r--;</span><br><span class="line">            <span class="keyword">while</span> (l &gt; event[i].l)	l--, update(A[l], <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">while</span> (l &lt; event[i].l)	update(A[l], <span class="number">-1</span>), l++;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> a, b, len = event[i].r - event[i].l + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                a = q_stat - len;</span><br><span class="line">                b = len * (len - <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a = <span class="number">0</span>, b = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ret[event[i].qid] = make_pair(a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> B[MAXV], q_stat;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        B[x] += val;</span><br><span class="line">        q_stat += val * <span class="number">2</span> * B[x] - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; off;</span><br><span class="line"><span class="keyword">int</span> Offline::Event::PILE = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">llgcd</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> x, <span class="keyword">long</span> <span class="keyword">long</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> t;</span><br><span class="line">    <span class="keyword">while</span> (x%y)</span><br><span class="line">        t = x, x = y, y = t%y;</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, M, l, r;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;N, &amp;M) == <span class="number">2</span>) &#123;</span><br><span class="line">        off.init(N);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;off.A[i]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;l, &amp;r);</span><br><span class="line">            off.q_add(l, r);</span><br><span class="line">        &#125;</span><br><span class="line">        off.run();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; off.ret.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> a = off.ret[i].first;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> b = off.ret[i].second;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> g = llgcd(a, b);</span><br><span class="line">            a /= g, b /= g;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%lld/%lld\n"</span>, a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">1 1</span><br><span class="line">5</span><br><span class="line">1 1</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-bzoj-3065" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/22/bzoj-3065/" class="article-date">
  <time datetime="2015-06-22T00:55:28.000Z" itemprop="datePublished">2015-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/22/bzoj-3065/">BZOJ 3065 帶插入區間 K 小值</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/22/bzoj-3065/" data-id="cimun1k3e0017n2xc5z1wspgv" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/22/bzoj-3065/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/塊狀鏈表/">塊狀鏈表</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>詢問區間 K 小，額外支持插入一個元素到序列中。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">10 5 8 28 0 19 2 31 1 22 </span><br><span class="line">30</span><br><span class="line">I 6 9</span><br><span class="line">M 1 11</span><br><span class="line">I 8 17</span><br><span class="line">M 1 31</span><br><span class="line">M 6 26</span><br><span class="line">Q 2 7 6</span><br><span class="line">I 23 30</span><br><span class="line">M 31 7</span><br><span class="line">I 22 27</span><br><span class="line">M 26 18</span><br><span class="line">Q 26 17 31</span><br><span class="line">I 5 2</span><br><span class="line">I 18 13</span><br><span class="line">Q 3 3 3</span><br><span class="line">I 27 19</span><br><span class="line">Q 23 23 30</span><br><span class="line">Q 5 13 5</span><br><span class="line">I 3 0</span><br><span class="line">M 15 27</span><br><span class="line">Q 0 28 13</span><br><span class="line">Q 3 29 11</span><br><span class="line">M 2 8</span><br><span class="line">Q 12 5 7</span><br><span class="line">I 30 19</span><br><span class="line">M 11 19</span><br><span class="line">Q 17 8 29</span><br><span class="line">M 29 4</span><br><span class="line">Q 3 0 12</span><br><span class="line">I 7 18</span><br><span class="line">M 29 27</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">28</span><br><span class="line">2</span><br><span class="line">31</span><br><span class="line">0</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">14</span><br><span class="line">27</span><br><span class="line">15</span><br><span class="line">14</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>直接修改可持久化塊狀鏈表的那一題 Zerojudge b411 記憶中的序列 2，把可持久化的記憶體拔掉，這樣就免得記憶體需求過大。出題者是想用替罪羊樹掛另一個平衡樹下去做。應該沒設想到塊狀鏈表在此題的速度也不算差。時限 60 秒大概跑了 30 秒，還不比樹套樹來得慢。</p>
<p>因為有插入操作，不管是主席樹還是函數式線段樹 (這兩個應該是同一個傢伙)，都無法辦到，只能靠可插入的平衡樹。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">65536</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">262144</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> UnrolledLinkedList &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Node &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A, B;</span><br><span class="line">        Node *next, *alias;</span><br><span class="line">        Node() &#123;</span><br><span class="line">            A.clear(), B.clear(), next = alias = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Node* <span class="title">real</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (alias)	<span class="keyword">return</span> alias;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (alias) &#123;</span><br><span class="line">                A = alias-&gt;A, B = alias-&gt;B;</span><br><span class="line">                alias = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            A.insert(A.begin() + x, val);</span><br><span class="line">            B.resize(A.size());</span><br><span class="line">            B[A.size()<span class="number">-1</span>] = val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) A.size()<span class="number">-1</span>; i &gt; <span class="number">0</span> &amp;&amp; B[i] &lt; B[i<span class="number">-1</span>]; i--)</span><br><span class="line">                swap(B[i], B[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> val = A[x];</span><br><span class="line">            A.erase(A.begin()+x);</span><br><span class="line">            B.erase(lower_bound(B.begin(), B.end(), val));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> t = A[x];</span><br><span class="line">            A[x] = val;</span><br><span class="line">            B.erase(lower_bound(B.begin(), B.end(), t));</span><br><span class="line">            B.resize(A.size());</span><br><span class="line">            B[A.size()<span class="number">-1</span>] = val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) A.size()<span class="number">-1</span>; i &gt; <span class="number">0</span> &amp;&amp; B[i] &lt; B[i<span class="number">-1</span>]; i--)</span><br><span class="line">                swap(B[i], B[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">relax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            B = A;</span><br><span class="line">            sort(B.begin(), B.end());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> PSIZE;</span><br><span class="line">    <span class="built_in">stack</span>&lt;Node*&gt; mem;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> n)</span> </span>&#123; <span class="comment">// A[1:n]</span></span><br><span class="line">        <span class="built_in">free</span>();</span><br><span class="line">        PSIZE = max((<span class="keyword">int</span>) <span class="built_in">sqrt</span>(n), <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; ; i &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= PSIZE) &#123;</span><br><span class="line">                PSIZE = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Node *u, *v, *head;</span><br><span class="line">        </span><br><span class="line">        head = newNode();</span><br><span class="line">        u = head, v = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;A.size() == PSIZE) &#123;</span><br><span class="line">                u-&gt;next = newNode();</span><br><span class="line">                v = u, u = u-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            u-&gt;A.push_back(A[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (u = head; u != <span class="literal">NULL</span>; u = u-&gt;next)</span><br><span class="line">            u-&gt;relax();</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node* p = <span class="keyword">new</span> Node();</span><br><span class="line">        mem.push(p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line">        Node *p = <span class="keyword">new</span> Node();</span><br><span class="line">        *p = *t, p-&gt;next = u-&gt;next, mem.push(p);</span><br><span class="line">        <span class="keyword">return</span> p; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">aliasNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line"><span class="comment">//		Node* p = new Node();</span></span><br><span class="line"><span class="comment">//		p-&gt;alias = t, p-&gt;next = u-&gt;next, mem.push(p);</span></span><br><span class="line"><span class="comment">//		return p;</span></span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">erase</span><span class="params">(Node *ver, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;erase(x - l);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> relaxList(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">insert</span><span class="params">(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l<span class="number">-1</span> &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;insert(x - l + <span class="number">1</span>, val);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> relaxList(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;change(x - l, val);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findRank</span><span class="params">(Node *ver, <span class="keyword">int</span> L, <span class="keyword">int</span> R, <span class="keyword">int</span> val, <span class="keyword">int</span> threshold = INT_MAX)</span> </span>&#123;</span><br><span class="line">        Node *u, *v;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        u = ver;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u != <span class="literal">NULL</span>; u = u-&gt;next, l = r+<span class="number">1</span>) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (L &lt;= l &amp;&amp; r &lt;= R) &#123;</span><br><span class="line">                ret += upper_bound(u-&gt;real()-&gt;B.begin(), u-&gt;real()-&gt;B.end(), val) - u-&gt;real()-&gt;B.begin();</span><br><span class="line">                L = r + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((l &lt;= L &amp;&amp; L &lt;= r) || (l &lt;= R &amp;&amp; R &lt;= r)) &#123;</span><br><span class="line">                <span class="keyword">int</span> i = L - l;</span><br><span class="line">                <span class="keyword">while</span> (i &lt; u-&gt;real()-&gt;A.size() &amp;&amp; L &lt;= R) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (u-&gt;real()-&gt;A[i] &lt;= val)</span><br><span class="line">                        ret++;</span><br><span class="line">                    i++, L++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= threshold)	<span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(Node *ver, <span class="keyword">int</span> L, <span class="keyword">int</span> R, <span class="keyword">int</span> k)</span>  </span>&#123;	<span class="comment">// kth-number</span></span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">100005</span>, mid, t = <span class="number">0</span>; <span class="comment">// value in A[]</span></span><br><span class="line">        <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">            mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (findRank(ver, L, R, mid, k) &gt;= k)</span><br><span class="line">                r = mid - <span class="number">1</span>, t = mid;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">mergeNode</span><span class="params">(Node *u, Node *v)</span> </span>&#123;</span><br><span class="line">        Node *p, *q;</span><br><span class="line">        Node *a = newNode();</span><br><span class="line">        p = u-&gt;real(), q = v-&gt;real();</span><br><span class="line">        a-&gt;next = v-&gt;next;</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.end(), p-&gt;A.begin(), p-&gt;A.end());</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.end(), q-&gt;A.begin(), q-&gt;A.end());</span><br><span class="line">        a-&gt;B.resize(a-&gt;A.size());</span><br><span class="line">        merge(p-&gt;B.begin(), p-&gt;B.end(), q-&gt;B.begin(), q-&gt;B.end(), a-&gt;B.begin());</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">splitNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line">        Node *a = newNode(), *b = newNode();</span><br><span class="line">        <span class="keyword">int</span> n = t-&gt;A.size()/<span class="number">2</span>;</span><br><span class="line">        a-&gt;next = b, b-&gt;next = u-&gt;next;</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.begin(), t-&gt;A.begin(), t-&gt;A.begin()+n);</span><br><span class="line">        b-&gt;A.insert(b-&gt;A.begin(), t-&gt;A.begin()+n, t-&gt;A.end());</span><br><span class="line">        a-&gt;relax(), b-&gt;relax();</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">relaxList</span><span class="params">(Node *ver)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        <span class="keyword">int</span> need = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (u = ver, a = <span class="literal">NULL</span>; !need &amp;&amp; u != <span class="literal">NULL</span>; u = u-&gt;next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next != <span class="literal">NULL</span> &amp;&amp; u-&gt;real()-&gt;A.size() + u-&gt;next-&gt;real()-&gt;A.size() &lt; (PSIZE&lt;&lt;<span class="number">1</span>)) <span class="comment">// merge</span></span><br><span class="line">            	need = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;real()-&gt;A.size() &gt; (PSIZE&lt;&lt;<span class="number">1</span>))	<span class="comment">// split</span></span><br><span class="line">            	need = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!need)</span><br><span class="line">        	<span class="keyword">return</span> ver;</span><br><span class="line">        <span class="built_in">stack</span>&lt;Node*&gt; remove;	<span class="comment">// static used </span></span><br><span class="line">        <span class="keyword">for</span> (u = ver, a = <span class="literal">NULL</span>; u != <span class="literal">NULL</span>; u = u-&gt;next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next != <span class="literal">NULL</span> &amp;&amp; u-&gt;real()-&gt;A.size() + u-&gt;next-&gt;real()-&gt;A.size() &lt; (PSIZE&lt;&lt;<span class="number">1</span>)) &#123;	<span class="comment">// merge</span></span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">            		a = mergeNode(u, u-&gt;next), b = a;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		b-&gt;next = mergeNode(u, u-&gt;next), b = b-&gt;next;</span><br><span class="line">            	remove.push(u), remove.push(u-&gt;next); <span class="comment">// static used  </span></span><br><span class="line">                u = u-&gt;next;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (u-&gt;real()-&gt;A.size() &gt; (PSIZE&lt;&lt;<span class="number">1</span>)) &#123;	<span class="comment">// split</span></span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">            		a = splitNode(u), b = a-&gt;next;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		b-&gt;next = splitNode(u), b = b-&gt;next-&gt;next;</span><br><span class="line">            	remove.push(u); <span class="comment">// static used  </span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)	</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">            	<span class="keyword">else</span>			</span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!remove.empty()) &#123; <span class="comment">// static used  </span></span><br><span class="line">        	u = remove.top(), remove.pop();</span><br><span class="line">        	<span class="keyword">delete</span> u;</span><br><span class="line">        &#125;	    	</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(Node *head)</span> </span>&#123;</span><br><span class="line">        Node *u = head;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"["</span>);</span><br><span class="line">    	<span class="keyword">while</span> (u != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; u-&gt;real()-&gt;A.size(); i++)</span><br><span class="line">            	<span class="built_in">printf</span>(<span class="string">"%d%s"</span>, u-&gt;real()-&gt;A[i], i != u-&gt;real()-&gt;A.size()<span class="number">-1</span> ? <span class="string">" "</span> : <span class="string">" "</span>);</span><br><span class="line">        	u = u-&gt;next;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">while</span> (!mem.empty()) &#123;</span><br><span class="line">            Node *u = mem.top();</span><br><span class="line">            mem.pop();</span><br><span class="line">            <span class="keyword">delete</span> u;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; dream; </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A[MAXN], n, q;</span><br><span class="line">UnrolledLinkedList::Node *ver[MAXQ];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x, y, v;</span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</span><br><span class="line">        ver[<span class="number">0</span>] = dream.init(A, n);</span><br><span class="line"><span class="comment">//		dream.debug(ver[0]);</span></span><br><span class="line">        <span class="keyword">int</span> encrypt = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;q);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>, cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">'I'</span>) &#123;</span><br><span class="line">                <span class="comment">// insert A[x] = v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</span><br><span class="line">                x ^= encrypt, v ^= encrypt;</span><br><span class="line">                ver[i] = dream.insert(ver[i<span class="number">-1</span>], x<span class="number">-1</span>, v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">'Q'</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;x, &amp;y, &amp;v);</span><br><span class="line">                x ^= encrypt, y ^= encrypt, v ^= encrypt;</span><br><span class="line">                <span class="keyword">int</span> t = dream.find(ver[i<span class="number">-1</span>], x, y, v);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, t);</span><br><span class="line">                encrypt = t;</span><br><span class="line">                ver[i] = ver[i<span class="number">-1</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd[<span class="number">0</span>] == <span class="string">'M'</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</span><br><span class="line">                x ^= encrypt, v ^= encrypt;</span><br><span class="line">                ver[i] = dream.change(ver[i<span class="number">-1</span>], x, v);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//			dream.debug(ver[i]);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">5</span><br><span class="line">1 2 3 4 5</span><br><span class="line">9999</span><br><span class="line">4 1 5 2</span><br><span class="line">1 2 1</span><br><span class="line">4 1 5 2</span><br><span class="line">0 1</span><br><span class="line">4 1 5 2</span><br><span class="line">2 1</span><br><span class="line">1 0 5</span><br><span class="line">3 3 9</span><br><span class="line">4 1 1 1</span><br><span class="line"></span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b412" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/22/zj-b412/" class="article-date">
  <time datetime="2015-06-22T00:38:41.000Z" itemprop="datePublished">2015-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/22/zj-b412/">b412. 記憶中的并查集</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/22/zj-b412/" data-id="cimun1kl200sdn2xcdnzsrgai" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/22/zj-b412/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并查集/">并查集</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>維護一個並查集的操作，並且支持版本回溯。</p>
<ul>
<li>合併兩個堆</li>
<li>詢問兩個元素是否同堆</li>
<li>版本回溯</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2 5</span><br><span class="line">2 1 2</span><br><span class="line">1 1 2</span><br><span class="line">2 1 2</span><br><span class="line">1 1</span><br><span class="line">3 0 3</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>持久化概念，相當於維護 <code>parent[]</code> 陣列的版本，這一點可以利用可持久化線段樹來維護。</p>
<p>並查集的查詢功能不修改 <code>parent[]</code> 陣列，合併操作卻有可能修改數個 <code>parent[]</code>，為了降低記憶體用量，盡可能少用路徑壓縮這個技巧，雖然在一般並查集都會使用這個來加速，否則很容易變很慢，是因為持久化是會拉低速度，因為持久化需要 $O(\log N)$ 的時間去更改 <code>parent[]</code>，單筆路徑壓縮長度為 $M$ 個點，需要 $O(M \log N)$ 的調整，$M$ 在並查集中是常數類。</p>
<p>詢問不多時用啟發式合併就好，將小堆的元素合併到大堆中。效能會比較好。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">3000000</span>;</span><br><span class="line"><span class="keyword">class</span> SegementTree &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Node &#123;</span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; val;</span><br><span class="line">    &#125; nodes[MAXN];</span><br><span class="line">    <span class="keyword">int</span> nodesize, L, R;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        nodesize = <span class="number">0</span>;</span><br><span class="line">        L = l, R = r;</span><br><span class="line">        Node* root = build(l, r);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nodesize &gt;= MAXN)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> &amp;nodes[nodesize++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nodesize &gt;= MAXN)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        Node* u = &amp;nodes[nodesize++];</span><br><span class="line">        *u = *p;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        Node *u = newNode();</span><br><span class="line">        u-&gt;lson = u-&gt;rson = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">            u-&gt;val = make_pair(l, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> m = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	u-&gt;lson = build(l, m);</span><br><span class="line">        	u-&gt;rson = build(m+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; val, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        Node *u = cloneNode(p);</span><br><span class="line">        <span class="keyword">if</span> (l == r) &#123;</span><br><span class="line">        	u-&gt;val = val;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        	<span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            	u-&gt;lson = change(p-&gt;lson, x, val, l, mid);</span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">         		u-&gt;rson = change(p-&gt;rson, x, val, mid+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *p, <span class="keyword">int</span> x, pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> change(p, x, val, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; find(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r) &#123;</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">        	<span class="keyword">return</span> ver-&gt;val;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            <span class="keyword">return</span> find(ver-&gt;lson, x, l, mid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> find(ver-&gt;rson, x, mid+<span class="number">1</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; find(Node *ver, <span class="keyword">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">return</span> find(ver, x, L, R);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// disjoint set</span></span><br><span class="line">    pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; findp(Node *ver, <span class="keyword">int</span> x) &#123;</span><br><span class="line">        pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; p = find(ver, x);</span><br><span class="line">        <span class="keyword">return</span> x == p.first ? p : findp(ver, p.first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">joint</span><span class="params">(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; a = findp(ver, x);</span><br><span class="line">        pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; b = findp(ver, y);</span><br><span class="line">        <span class="keyword">if</span> (a.first == b.first)</span><br><span class="line">            <span class="keyword">return</span> ver;</span><br><span class="line">        Node *u = ver;</span><br><span class="line">        <span class="keyword">if</span> (a.second &gt; b.second) &#123;</span><br><span class="line">            u = change(u, b.first, make_pair(a.first, b.second));</span><br><span class="line">            u = change(u, a.first, make_pair(a.first, a.second + b.second));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            u = change(u, a.first, make_pair(b.first, a.second));</span><br><span class="line">            u = change(u, b.first, make_pair(b.first, a.second + b.second));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; segTree;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">262144</span>;</span><br><span class="line">SegementTree::Node *ver[MAXQ];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line">    <span class="keyword">int</span> cmd, x, y, v;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;n, &amp;m) == <span class="number">2</span>) &#123;</span><br><span class="line">        ver[<span class="number">0</span>] = segTree.init(<span class="number">1</span>, n);</span><br><span class="line">        <span class="keyword">int</span> encrypt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</span><br><span class="line">            cmd ^= encrypt;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123; 		<span class="comment">// back</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v);</span><br><span class="line">                v ^= encrypt;</span><br><span class="line">                ver[i] = ver[v];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;	<span class="comment">// joint</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt; </span><br><span class="line">                ver[i] = segTree.joint(ver[i<span class="number">-1</span>], x, y);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;	<span class="comment">// find</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt;</span><br><span class="line">                pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; a = segTree.findp(ver[i<span class="number">-1</span>], x);</span><br><span class="line">                pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; b = segTree.findp(ver[i<span class="number">-1</span>], y);</span><br><span class="line">                <span class="keyword">int</span> t = a.first == b.first;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, t);</span><br><span class="line">                ver[i] = ver[i<span class="number">-1</span>];</span><br><span class="line">                encrypt = t;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"WTF"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b411" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/22/zj-b411/" class="article-date">
  <time datetime="2015-06-22T00:28:54.000Z" itemprop="datePublished">2015-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/22/zj-b411/">b411. 記憶中的序列 2</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/22/zj-b411/" data-id="cimun1kl000s9n2xcouhk6gq1" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/22/zj-b411/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/塊狀鏈表/">塊狀鏈表</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>動態區間 K 小，有四種操作</p>
<ul>
<li>插入元素</li>
<li>刪除元素</li>
<li>修改元素</li>
<li>版本回溯</li>
<li>詢問某個區間的第 K 小元素</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">1 2 3 4 5</span><br><span class="line">5</span><br><span class="line">4 1 5 2</span><br><span class="line">3 0 3</span><br><span class="line">6 3 7 0</span><br><span class="line">1 0</span><br><span class="line">5 0 4 3</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>每次操作最多增加 $O(\sqrt{n})$ 記憶體，需要針對節點作抽象化，修改節點時再進行實體化，如此一來不用針對搜索路徑上的每一節點都進行複製，一般持久化平衡樹進行時，會直接複製整個節點，但塊狀鏈表若是複製下去會退化成時間、空間都是 $O(n)$ 的情況。</p>
<p>詢問時仍然需要二分搜索答案，看答案是否符合 K 小元素，也就是說要得到某個元素在區間中的排名。</p>
<p>塊狀鏈表代碼很醜，看看就好。如果需要支持修改、增加元素的區間 K 小，雖然複雜度高，但常數小、記憶體快取優勢，速度不比二元樹類型的資料結構來得慢，不管需不需要持久化塊狀鏈表都是這類型不錯的選擇。</p>
<h3 id="另解"><a href="#另解" class="headerlink" title="另解"></a>另解</h3><p>假設詢問為 $Q$ 個，聽說可以用區間 $[1, 2NQ]$ 的線段樹之類的超大區間線段樹，必要的探訪時進行開花 (將子節點打開)，利用標記計算相對位置來進行查詢。相對位置計算大概會在邊緣情況崩潰。</p>
<p>至於柳柳州提到的替罪羊樹是樹套樹下去持久化，每一個節點表示一個區間，接著在節點中建造一個平衡樹來查找區間 K 小元素。這樣的做法一樣需要二分搜索答案。但塊狀鏈表在速度跟記憶體都贏了，因為樹套樹的常數比較大，增加的記憶體也多。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">32767</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXQ = <span class="number">131072</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> UnrolledLinkedList &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Node &#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A, B;</span><br><span class="line">        Node *next, *alias;</span><br><span class="line">        Node() &#123;</span><br><span class="line">            A.clear(), B.clear(), next = alias = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Node* <span class="title">real</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (alias)	<span class="keyword">return</span> alias;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (alias) &#123;</span><br><span class="line">                A = alias-&gt;A, B = alias-&gt;B;</span><br><span class="line">                alias = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            A.insert(A.begin() + x, val);</span><br><span class="line">            B.resize(A.size());</span><br><span class="line">            B[A.size()<span class="number">-1</span>] = val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) A.size()<span class="number">-1</span>; i &gt; <span class="number">0</span> &amp;&amp; B[i] &lt; B[i<span class="number">-1</span>]; i--)</span><br><span class="line">                swap(B[i], B[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> val = A[x];</span><br><span class="line">            A.erase(A.begin()+x);</span><br><span class="line">            B.erase(lower_bound(B.begin(), B.end(), val));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> t = A[x];</span><br><span class="line">            A[x] = val;</span><br><span class="line">            B.erase(lower_bound(B.begin(), B.end(), t));</span><br><span class="line">            B.resize(A.size());</span><br><span class="line">            B[A.size()<span class="number">-1</span>] = val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) A.size()<span class="number">-1</span>; i &gt; <span class="number">0</span> &amp;&amp; B[i] &lt; B[i<span class="number">-1</span>]; i--)</span><br><span class="line">                swap(B[i], B[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">relax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            B = A;</span><br><span class="line">            sort(B.begin(), B.end());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> PSIZE;</span><br><span class="line">    <span class="built_in">stack</span>&lt;Node*&gt; mem;</span><br><span class="line">    <span class="function">Node* <span class="title">init</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> n)</span> </span>&#123; <span class="comment">// A[1:n]</span></span><br><span class="line">        <span class="built_in">free</span>();</span><br><span class="line">        PSIZE = max((<span class="keyword">int</span>) <span class="built_in">sqrt</span>(n), <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; ; i &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= PSIZE) &#123;</span><br><span class="line">                PSIZE = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Node *u, *v, *head;</span><br><span class="line">        </span><br><span class="line">        head = newNode();</span><br><span class="line">        u = head, v = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;A.size() == PSIZE) &#123;</span><br><span class="line">                u-&gt;next = newNode();</span><br><span class="line">                v = u, u = u-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            u-&gt;A.push_back(A[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (u = head; u != <span class="literal">NULL</span>; u = u-&gt;next)</span><br><span class="line">            u-&gt;relax();</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">newNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node* p = <span class="keyword">new</span> Node();</span><br><span class="line">        mem.push(p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line">        Node *p = <span class="keyword">new</span> Node();</span><br><span class="line">        *p = *t, p-&gt;next = u-&gt;next, mem.push(p);</span><br><span class="line">        <span class="keyword">return</span> p; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">aliasNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line">        Node* p = <span class="keyword">new</span> Node();</span><br><span class="line">        p-&gt;alias = t, p-&gt;next = u-&gt;next, mem.push(p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">erase</span><span class="params">(Node *ver, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;erase(x - l);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> relaxList(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">insert</span><span class="params">(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l<span class="number">-1</span> &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;insert(x - l + <span class="number">1</span>, val);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> relaxList(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">change</span><span class="params">(Node *ver, <span class="keyword">int</span> x, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        u = ver, a = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u; l = r+<span class="number">1</span>, u = u-&gt;next) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= x &amp;&amp; x &lt;= r) &#123;</span><br><span class="line">                t = cloneNode(u);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = t, b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = t, b = b-&gt;next;</span><br><span class="line">                t-&gt;change(x - l, val);</span><br><span class="line">                t-&gt;next = u-&gt;next;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findRank</span><span class="params">(Node *ver, <span class="keyword">int</span> L, <span class="keyword">int</span> R, <span class="keyword">int</span> val, <span class="keyword">int</span> threshold = INT_MAX)</span> </span>&#123;</span><br><span class="line">        Node *u, *v;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        u = ver;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>, r; u != <span class="literal">NULL</span>; u = u-&gt;next, l = r+<span class="number">1</span>) &#123;</span><br><span class="line">            r = l + u-&gt;real()-&gt;A.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (L &lt;= l &amp;&amp; r &lt;= R) &#123;</span><br><span class="line">                ret += upper_bound(u-&gt;real()-&gt;B.begin(), u-&gt;real()-&gt;B.end(), val) - u-&gt;real()-&gt;B.begin();</span><br><span class="line">                L = r + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((l &lt;= L &amp;&amp; L &lt;= r) || (l &lt;= R &amp;&amp; R &lt;= r)) &#123;</span><br><span class="line">                <span class="keyword">int</span> i = L - l;</span><br><span class="line">                <span class="keyword">while</span> (i &lt; u-&gt;real()-&gt;A.size() &amp;&amp; L &lt;= R) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (u-&gt;real()-&gt;A[i] &lt;= val)</span><br><span class="line">                        ret++;</span><br><span class="line">                    i++, L++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret &gt;= threshold)	<span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(Node *ver, <span class="keyword">int</span> L, <span class="keyword">int</span> R, <span class="keyword">int</span> k)</span>  </span>&#123;	<span class="comment">// kth-number</span></span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>, r = <span class="number">100000</span>, mid, t = <span class="number">0</span>; <span class="comment">// value in A[]</span></span><br><span class="line">        <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">            mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (findRank(ver, L, R, mid, k) &gt;= k)</span><br><span class="line">                r = mid - <span class="number">1</span>, t = mid;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">mergeNode</span><span class="params">(Node *u, Node *v)</span> </span>&#123;</span><br><span class="line">        Node *p, *q;</span><br><span class="line">        Node *a = newNode();</span><br><span class="line">        p = u-&gt;real(), q = v-&gt;real();</span><br><span class="line">        a-&gt;next = v-&gt;next;</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.end(), p-&gt;A.begin(), p-&gt;A.end());</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.end(), q-&gt;A.begin(), q-&gt;A.end());</span><br><span class="line">        a-&gt;B.resize(a-&gt;A.size());</span><br><span class="line">        merge(p-&gt;B.begin(), p-&gt;B.end(), q-&gt;B.begin(), q-&gt;B.end(), a-&gt;B.begin());</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">splitNode</span><span class="params">(Node *u)</span> </span>&#123;</span><br><span class="line">        Node *t = u-&gt;real();</span><br><span class="line">        Node *a = newNode(), *b = newNode();</span><br><span class="line">        <span class="keyword">int</span> n = t-&gt;A.size()/<span class="number">2</span>;</span><br><span class="line">        a-&gt;next = b, b-&gt;next = u-&gt;next;</span><br><span class="line">        a-&gt;A.insert(a-&gt;A.begin(), t-&gt;A.begin(), t-&gt;A.begin()+n);</span><br><span class="line">        b-&gt;A.insert(b-&gt;A.begin(), t-&gt;A.begin()+n, t-&gt;A.end());</span><br><span class="line">        a-&gt;relax(), b-&gt;relax();</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Node* <span class="title">relaxList</span><span class="params">(Node *ver)</span> </span>&#123;</span><br><span class="line">        Node *a, *b, *u, *v, *t;</span><br><span class="line">        <span class="keyword">int</span> need = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (u = ver, a = <span class="literal">NULL</span>; !need &amp;&amp; u != <span class="literal">NULL</span>; u = u-&gt;next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next != <span class="literal">NULL</span> &amp;&amp; u-&gt;real()-&gt;A.size() + u-&gt;next-&gt;real()-&gt;A.size() &lt; (PSIZE&lt;&lt;<span class="number">1</span>)) <span class="comment">// merge</span></span><br><span class="line">            	need = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;real()-&gt;A.size() &gt; (PSIZE&lt;&lt;<span class="number">1</span>))	<span class="comment">// split</span></span><br><span class="line">            	need = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!need)</span><br><span class="line">        	<span class="keyword">return</span> ver;</span><br><span class="line">        	</span><br><span class="line">        <span class="keyword">for</span> (u = ver, a = <span class="literal">NULL</span>; u != <span class="literal">NULL</span>; u = u-&gt;next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (u-&gt;next != <span class="literal">NULL</span> &amp;&amp; u-&gt;real()-&gt;A.size() + u-&gt;next-&gt;real()-&gt;A.size() &lt; (PSIZE&lt;&lt;<span class="number">1</span>)) &#123;	<span class="comment">// merge</span></span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">            		a = mergeNode(u, u-&gt;next), b = a;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		b-&gt;next = mergeNode(u, u-&gt;next), b = b-&gt;next;</span><br><span class="line">                u = u-&gt;next;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (u-&gt;real()-&gt;A.size() &gt; (PSIZE&lt;&lt;<span class="number">1</span>)) &#123;	<span class="comment">// split</span></span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)</span><br><span class="line">            		a = splitNode(u), b = a-&gt;next;</span><br><span class="line">            	<span class="keyword">else</span></span><br><span class="line">            		b-&gt;next = splitNode(u), b = b-&gt;next-&gt;next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            	<span class="keyword">if</span> (a == <span class="literal">NULL</span>)	</span><br><span class="line">                    a = aliasNode(u), b = a;</span><br><span class="line">            	<span class="keyword">else</span>			</span><br><span class="line">                    b-&gt;next = aliasNode(u), b = b-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(Node *head)</span> </span>&#123;</span><br><span class="line">        Node *u = head;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"["</span>);</span><br><span class="line">    	<span class="keyword">while</span> (u != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; u-&gt;real()-&gt;A.size(); i++)</span><br><span class="line">            	<span class="built_in">printf</span>(<span class="string">"%d%s"</span>, u-&gt;real()-&gt;A[i], i != u-&gt;real()-&gt;A.size()<span class="number">-1</span> ? <span class="string">" "</span> : <span class="string">" "</span>);</span><br><span class="line">        	u = u-&gt;next;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!mem.empty()) &#123;</span><br><span class="line">            Node *u = mem.top();</span><br><span class="line">            mem.pop();</span><br><span class="line">            <span class="keyword">delete</span> u;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; dream; </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A[MAXN], n, q;</span><br><span class="line">UnrolledLinkedList::Node *ver[MAXQ];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x, y, v, cmd;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;A[i]);</span><br><span class="line">        ver[<span class="number">0</span>] = dream.init(A, n);</span><br><span class="line"><span class="comment">//		dream.debug(ver[0]);</span></span><br><span class="line">        <span class="keyword">int</span> encrypt = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;q);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;cmd);</span><br><span class="line">            cmd ^= encrypt;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;			<span class="comment">// back version v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v);</span><br><span class="line">                v ^= encrypt;</span><br><span class="line">                ver[i] = ver[v];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123; 	<span class="comment">// insert A[x] = v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</span><br><span class="line">                x ^= encrypt, v ^= encrypt;</span><br><span class="line">                ver[i] = dream.insert(ver[i<span class="number">-1</span>], x, v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;	<span class="comment">// delete A[x]</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;x);</span><br><span class="line">                x ^= encrypt;</span><br><span class="line">                ver[i] = dream.erase(ver[i<span class="number">-1</span>], x);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;	<span class="comment">// make A[x] = v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d"</span>, &amp;x, &amp;v);</span><br><span class="line">                x ^= encrypt, v ^= encrypt;</span><br><span class="line">                ver[i] = dream.change(ver[i<span class="number">-1</span>], x, v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;x, &amp;y, &amp;v);</span><br><span class="line">                x ^= encrypt, y ^= encrypt, v ^= encrypt;</span><br><span class="line">                <span class="keyword">int</span> t = dream.find(ver[i<span class="number">-1</span>], x, y, v);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, t);</span><br><span class="line">                encrypt = t;</span><br><span class="line">                ver[i] = ver[i<span class="number">-1</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"WTF"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//			dream.debug(ver[i]);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-zj-b405" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/16/zj-b405/" class="article-date">
  <time datetime="2015-06-15T23:08:13.000Z" itemprop="datePublished">2015-06-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/16/zj-b405/">b405. 記憶中的序列</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/16/zj-b405/" data-id="cimun1kkw00s1n2xcgg7fpjlh" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/16/zj-b405/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/treap/">treap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/可持久化/">可持久化</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一個序列，支持插入元素、刪除元素、反轉區間、區間極值、區間總和、區間修改以及最重要的 <strong> 版本回溯 </strong>。</p>
<p>題目輸入會拿上一個答案進行 XOR 的加密，</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">9 81 28 6 40 68 74 50 82 62 </span><br><span class="line">15</span><br><span class="line">1 1 83</span><br><span class="line">2 11</span><br><span class="line">3 7 8</span><br><span class="line">4 4 10 28</span><br><span class="line">5 2 6</span><br><span class="line">85 82 89</span><br><span class="line">14 13 13</span><br><span class="line">56 61</span><br><span class="line">57 57 40</span><br><span class="line">58 61</span><br><span class="line">59 61 63</span><br><span class="line">60 57 59 4</span><br><span class="line">61 58 49</span><br><span class="line">137 139 136</span><br><span class="line">37 38 42</span><br></pre></td></tr></table></figure>
<p>decrypt input</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">9 81 28 6 40 68 74 50 82 62</span><br><span class="line">15</span><br><span class="line">1 1 83</span><br><span class="line">2 11</span><br><span class="line">3 7 8</span><br><span class="line">4 4 10 28</span><br><span class="line">5 2 6</span><br><span class="line">6 1 10</span><br><span class="line">7 4 4</span><br><span class="line">0 5</span><br><span class="line">1 1 16</span><br><span class="line">2 5</span><br><span class="line">3 5 7</span><br><span class="line">4 1 3 60</span><br><span class="line">5 2 9</span><br><span class="line">6 4 7</span><br><span class="line">7 4 8</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">83</span><br><span class="line">9</span><br><span class="line">56</span><br><span class="line">143</span><br><span class="line">34</span><br><span class="line">381</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>持久化 treap，區間反轉，區間最大值，區間最小值，區間總和，插入元素，刪除元素，操作回溯。</p>
<p>這坑爹的題目描述擺明就是拖人下水，只好含淚地寫下去。持久化類型的題目應該是告一段落，就差一個 LCP + HASH 的維護了吧。麻煩的地方在於持久化的懶操作標記傳遞時都要新增加一個節點，這項舉動導致記憶體量非常多，1 秒處理的資訊吃掉 512 MB。二分記憶體上限，終於找到內存池的最多元素個數，中間不小心把多項資訊的 <code>int</code> 型態宣告成 <code>long long</code>，導致內存池一直不夠大。</p>
<p>如果不考慮回溯操作，速度上沒有比暴力算法來得快上很多，treap 基於隨機數的調整，而且每一次修改元素都要增加很多記憶體來補，導致速度上無法領先太多。但如果用暴力法，會造成版本回溯問題，空間會到 $O(<br>n^2)$，不允許的狀態，持久化造就的平均空間使用 $O(Q log N \times sizeof(Node))$，看起來仍然是很巨大的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN 7100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXQ 60005</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> PersistentTreap &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Node;</span><br><span class="line">    <span class="keyword">static</span> Node *null;</span><br><span class="line">    <span class="keyword">struct</span> Node &#123;</span><br><span class="line">        Node *lson, *rson;</span><br><span class="line">        <span class="keyword">int</span> key, size;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> val, mnval, mxval, sumval;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> adel; <span class="comment">// delivery</span></span><br><span class="line">        <span class="keyword">int</span> rdel;</span><br><span class="line">        </span><br><span class="line">        Node(<span class="keyword">long</span> <span class="keyword">long</span> c = <span class="number">0</span>, <span class="keyword">int</span> s = <span class="number">1</span>): size(s) &#123;</span><br><span class="line">            lson = rson = null;</span><br><span class="line">            key = rand();</span><br><span class="line">            val = mnval = mxval = sumval = c;</span><br><span class="line">            adel = rdel = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">            size += lson-&gt;size + rson-&gt;size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mnval = mxval = sumval = val;</span><br><span class="line">            <span class="keyword">if</span> (lson != null) &#123;</span><br><span class="line">                mnval = min(mnval, lson-&gt;mnval + lson-&gt;adel);</span><br><span class="line">                mxval = max(mxval, lson-&gt;mxval + lson-&gt;adel);</span><br><span class="line">                sumval += lson-&gt;sumval + lson-&gt;adel * lson-&gt;size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rson != null) &#123;</span><br><span class="line">                mnval = min(mnval, rson-&gt;mnval + rson-&gt;adel);</span><br><span class="line">                mxval = max(mxval, rson-&gt;mxval + rson-&gt;adel);</span><br><span class="line">                sumval += rson-&gt;sumval + rson-&gt;adel * rson-&gt;size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">pushDown</span><span class="params">(PersistentTreap &amp;treap)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (adel) &#123;</span><br><span class="line">                val += adel, mnval += adel, mxval += adel;</span><br><span class="line">                <span class="keyword">if</span> (lson != null) &#123;</span><br><span class="line">                	lson = treap.cloneNode(lson);</span><br><span class="line">                    lson-&gt;adel += adel;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rson != null) &#123;</span><br><span class="line">                	rson = treap.cloneNode(rson);</span><br><span class="line">                    rson-&gt;adel += adel;</span><br><span class="line">                &#125;</span><br><span class="line">                adel = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rdel&amp;<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (lson == null)</span><br><span class="line">                    lson = rson, rson = null;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rson == null)</span><br><span class="line">                    rson = lson, lson = null;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    swap(lson, rson);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (lson != null) &#123;</span><br><span class="line">                	lson = treap.cloneNode(lson);</span><br><span class="line">                    lson-&gt;rdel += rdel;</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">if</span> (rson != null) &#123;</span><br><span class="line">                    rson = treap.cloneNode(rson);</span><br><span class="line">                    rson-&gt;rdel += rdel;</span><br><span class="line">                &#125;</span><br><span class="line">                rdel = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pushUp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXN], *root[MAXQ];</span><br><span class="line">    <span class="keyword">int</span> bufIdx, verIdx;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Node* <span class="title">merge</span><span class="params">(Node* a, Node* b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (a == null)	<span class="keyword">return</span> cloneNode(b);</span><br><span class="line">        <span class="keyword">if</span> (b == null)	<span class="keyword">return</span> cloneNode(a);</span><br><span class="line">        <span class="keyword">if</span> (a != null)	a-&gt;pushDown(*<span class="keyword">this</span>);</span><br><span class="line">    	<span class="keyword">if</span> (b != null)	b-&gt;pushDown(*<span class="keyword">this</span>);</span><br><span class="line">        Node *ret;</span><br><span class="line">        <span class="keyword">if</span> (a-&gt;key &lt; b-&gt;key) &#123;</span><br><span class="line">            ret = cloneNode(a);</span><br><span class="line">            ret-&gt;rson = merge(a-&gt;rson, b);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret = cloneNode(b);</span><br><span class="line">            ret-&gt;lson = merge(a, b-&gt;lson);</span><br><span class="line">        &#125;</span><br><span class="line">        ret-&gt;update();</span><br><span class="line">        ret-&gt;pushUp();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(Node* a, Node* &amp;l, Node* &amp;r, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            l = null, r = cloneNode(a);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> (a-&gt;size &lt;= n) &#123;</span><br><span class="line">            l = cloneNode(a), r = null;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;         </span><br><span class="line">        <span class="keyword">if</span> (a != null)</span><br><span class="line">            a-&gt;pushDown(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (a-&gt;lson-&gt;size &gt;= n) &#123;</span><br><span class="line">            r = cloneNode(a);</span><br><span class="line">            split(a-&gt;lson, l, r-&gt;lson, n);</span><br><span class="line">            r-&gt;update();</span><br><span class="line">            r-&gt;pushUp();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            l = cloneNode(a);</span><br><span class="line">            split(a-&gt;rson, l-&gt;rson, r, n - (a-&gt;lson-&gt;size) - <span class="number">1</span>);</span><br><span class="line">            l-&gt;update();</span><br><span class="line">            l-&gt;pushUp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node* &amp;a, Node *ver, <span class="keyword">int</span> pos, <span class="keyword">long</span> <span class="keyword">long</span> s[], <span class="keyword">int</span> sn)</span> </span>&#123;</span><br><span class="line">        Node *p, *q, *r;</span><br><span class="line">        <span class="keyword">int</span> n = sn;</span><br><span class="line">        split(ver, p, q, pos);</span><br><span class="line">        build(r, <span class="number">0</span>, n - <span class="number">1</span>, s);</span><br><span class="line">        p = merge(p, r);</span><br><span class="line">        a = merge(p, q);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(Node* &amp;a, Node *ver, <span class="keyword">int</span> pos, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        Node *p, *q, *r;</span><br><span class="line">        split(ver, p, q, pos - <span class="number">1</span>);</span><br><span class="line">        split(q, q, r, n);</span><br><span class="line">        a = merge(p, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(Node* &amp;a, Node *ver, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        Node *p, *q, *r;</span><br><span class="line">        split(ver, p, q, left - <span class="number">1</span>);</span><br><span class="line">        split(q, q, r, right - left + <span class="number">1</span>);</span><br><span class="line">        q-&gt;rdel++;</span><br><span class="line">        a = merge(p, q);</span><br><span class="line">        a = merge(a, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Node* &amp;a, Node *ver, <span class="keyword">int</span> left, <span class="keyword">int</span> right, <span class="keyword">long</span> <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        Node *p, *q, *r;</span><br><span class="line">        split(ver, p, q, left - <span class="number">1</span>);</span><br><span class="line">        split(q, q, r, right - left + <span class="number">1</span>);</span><br><span class="line">        q-&gt;adel += val;</span><br><span class="line">        a = merge(p, q);</span><br><span class="line">        a = merge(a, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> q_sum, q_max, q_min;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_dfs</span><span class="params">(Node *u, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        left = max(left, <span class="number">1</span>);</span><br><span class="line">        right = min(right, u-&gt;size);</span><br><span class="line">        <span class="keyword">if</span> (left &gt; right)</span><br><span class="line">            <span class="keyword">return</span>;        </span><br><span class="line">        <span class="keyword">if</span> (u != null)</span><br><span class="line">            u-&gt;pushDown(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">int</span> lsz = u-&gt;lson != null ? u-&gt;lson-&gt;size : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> rsz = u-&gt;rson != null ? u-&gt;rson-&gt;size : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left == <span class="number">1</span> &amp;&amp; right == lsz + rsz + <span class="number">1</span>) &#123;</span><br><span class="line">            q_sum += u-&gt;sumval;</span><br><span class="line">            q_max = max(q_max, u-&gt;mxval);</span><br><span class="line">            q_min = min(q_min, u-&gt;mnval);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left &lt;= lsz+<span class="number">1</span> &amp;&amp; lsz+<span class="number">1</span> &lt;= right) &#123;</span><br><span class="line">            q_sum += u-&gt;val;</span><br><span class="line">            q_max = max(q_max, u-&gt;val);</span><br><span class="line">            q_min = min(q_min, u-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (u-&gt;lson != null &amp;&amp; left &lt;= lsz)</span><br><span class="line">            q_dfs(u-&gt;lson, left, right);</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;rson != null &amp;&amp; right &gt; lsz+<span class="number">1</span>)</span><br><span class="line">            q_dfs(u-&gt;rson, left - lsz - <span class="number">1</span>, right - lsz - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">q_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        q_max = LONG_LONG_MIN;</span><br><span class="line">        q_min = LONG_LONG_MAX;</span><br><span class="line">        q_sum = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">findMax</span><span class="params">(Node *ver, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        q_init();</span><br><span class="line">        q_dfs(ver, left, right);</span><br><span class="line">        <span class="keyword">return</span> q_max;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">findMin</span><span class="params">(Node *ver, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        q_init();</span><br><span class="line">        q_dfs(ver, left, right);</span><br><span class="line">        <span class="keyword">return</span> q_min;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">findSum</span><span class="params">(Node *ver, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        q_init();</span><br><span class="line">        q_dfs(ver, left, right);</span><br><span class="line">        <span class="keyword">return</span> q_sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(Node *ver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ver == null)	<span class="keyword">return</span>;</span><br><span class="line">        ver-&gt;pushDown(*<span class="keyword">this</span>);</span><br><span class="line">        print(ver-&gt;lson);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%3lld]"</span>, ver-&gt;val);</span><br><span class="line">        print(ver-&gt;rson);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bufIdx = verIdx = <span class="number">0</span>;</span><br><span class="line">        root[verIdx] = null;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function">Node* <span class="title">cloneNode</span><span class="params">(Node* u)</span> </span>&#123;</span><br><span class="line">        Node *ret;</span><br><span class="line">        <span class="keyword">if</span> (u == null) &#123;</span><br><span class="line">            <span class="keyword">return</span> u;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="keyword">if</span> (bufIdx &gt;= MAXN)</span><br><span class="line">        		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            assert(bufIdx &lt; MAXN);</span><br><span class="line">            ret = &amp;nodes[bufIdx++];</span><br><span class="line">            *ret = *u;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(Node* &amp;a, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">long</span> <span class="keyword">long</span> s[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; r)	<span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">int</span> m = (l + r) /<span class="number">2</span>;</span><br><span class="line">        Node u = Node(s[m]), *p = &amp;u, *q;</span><br><span class="line">        a = cloneNode(p), p = null, q = null;</span><br><span class="line">        build(p, l, m<span class="number">-1</span>, s);</span><br><span class="line">        build(q, m+<span class="number">1</span>, r, s);</span><br><span class="line">        p = merge(p, a);</span><br><span class="line">        a = merge(p, q);</span><br><span class="line">        a-&gt;update();</span><br><span class="line">        a-&gt;pushUp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line">PersistentTreap::<span class="function">Node <span class="title">t</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">PersistentTreap::Node *PersistentTreap::null = &amp;t;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> A[<span class="number">65536</span>];</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> cmd, x, y, v;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;A[i]);</span><br><span class="line">        tree.init();</span><br><span class="line">        tree.insert(tree.root[<span class="number">0</span>], tree.null, <span class="number">0</span>, A+<span class="number">1</span>, N);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;Q);</span><br><span class="line">        <span class="keyword">int</span> verIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> encrypt = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;cmd);</span><br><span class="line">            cmd ^= encrypt;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123; 		<span class="comment">// insert</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;v);</span><br><span class="line">                x ^= encrypt, v ^= encrypt;</span><br><span class="line">                <span class="keyword">long</span> <span class="keyword">long</span> B[] = &#123;v&#125;;</span><br><span class="line">                tree.insert(tree.root[i], tree.root[verIdx], (<span class="keyword">int</span>) x, B, <span class="number">1</span>);</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123; 	<span class="comment">// erase</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;x);</span><br><span class="line">                x ^= encrypt;</span><br><span class="line">                tree.erase(tree.root[i], tree.root[verIdx], (<span class="keyword">int</span>) x, <span class="number">1</span>);</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123; 	<span class="comment">// reverse</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt;</span><br><span class="line">                tree.reverse(tree.root[i], tree.root[verIdx], (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123; 	<span class="comment">// [x, y] += v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld %lld"</span>, &amp;x, &amp;y, &amp;v);</span><br><span class="line">                x ^= encrypt, y ^= encrypt, v ^= encrypt;</span><br><span class="line">                tree.add(tree.root[i], tree.root[verIdx], (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y, v);</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">5</span>) &#123;  <span class="comment">// max(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt;</span><br><span class="line">                ret = tree.findMax(tree.root[verIdx], (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">                encrypt = ret;</span><br><span class="line">                tree.root[i] = tree.root[verIdx];</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">6</span>) &#123;  <span class="comment">// min(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt;</span><br><span class="line">                ret = tree.findMin(tree.root[verIdx], (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">                encrypt = ret;</span><br><span class="line">                tree.root[i] = tree.root[verIdx];</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">7</span>) &#123;  <span class="comment">// sum(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                x ^= encrypt, y ^= encrypt; </span><br><span class="line">                ret = tree.findSum(tree.root[verIdx], (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">                encrypt = ret;</span><br><span class="line">                tree.root[i] = tree.root[verIdx];</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;  <span class="comment">// back Day x-th</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;x);</span><br><span class="line">                x ^= encrypt;</span><br><span class="line">                tree.root[i] = tree.root[x];</span><br><span class="line">                verIdx = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"WTF"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Test-Code"><a href="#Test-Code" class="headerlink" title="Test Code"></a>Test Code</h3><p>暴力法驗證用，不支持加密的輸入運行，用一個 <code>vector</code> 完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXN (1&lt;&lt;19)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXQ 65536</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N, Q;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> A[<span class="number">65536</span>];</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> cmd, x, y, v;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;A[i]);</span><br><span class="line">        <span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; &gt; L;</span><br><span class="line">        L.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt;(A+<span class="number">1</span>, A+<span class="number">1</span>+N));</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;Q);</span><br><span class="line">        <span class="keyword">int</span> verIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> encrypt = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= Q; i++) &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;cmd);</span><br><span class="line">            <span class="built_in">vector</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; TA = L[verIdx];</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="number">1</span>) &#123;         <span class="comment">// insert</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;v);</span><br><span class="line">                TA.insert(TA.begin()+x, v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">2</span>) &#123;  <span class="comment">// erase</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;x);</span><br><span class="line">                TA.erase(TA.begin()+x<span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;  <span class="comment">// reverse</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                reverse(TA.begin()+x<span class="number">-1</span>, TA.begin()+y);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;  <span class="comment">// [x, y] += v</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld %lld"</span>, &amp;x, &amp;y, &amp;v);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) x<span class="number">-1</span>; i &lt; y; i++)</span><br><span class="line">                    TA[i] += v;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">5</span>) &#123;  <span class="comment">// max(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                <span class="keyword">long</span> <span class="keyword">long</span> ret = LONG_LONG_MIN;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) x<span class="number">-1</span>; i &lt; y; i++)</span><br><span class="line">                    ret = max(ret, TA[i]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">6</span>) &#123;  <span class="comment">// min(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                <span class="keyword">long</span> <span class="keyword">long</span> ret = LONG_LONG_MAX;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) x<span class="number">-1</span>; i &lt; y; i++)</span><br><span class="line">                    ret = min(ret, TA[i]);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">7</span>) &#123;  <span class="comment">// sum(A[x:y])</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld %lld"</span>, &amp;x, &amp;y);</span><br><span class="line">                <span class="keyword">long</span> <span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = (<span class="keyword">int</span>) x<span class="number">-1</span>; i &lt; y; i++)</span><br><span class="line">                    ret += TA[i];</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ret);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;  <span class="comment">// back Day x-th</span></span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;x);</span><br><span class="line">                TA = L[x];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"WTF"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            L.push_back(TA), verIdx = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"version %d\n"</span>, i);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x: TA)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[%3lld]"</span>, x);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Test-Generator"><a href="#Test-Generator" class="headerlink" title="Test Generator"></a>Test Generator</h3><p>小測資檢驗用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     srand (time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">int</span> testcase, n, m, x, y;</span><br><span class="line">    <span class="keyword">int</span> A[<span class="number">100</span>];</span><br><span class="line">    testcase = <span class="number">1</span>;</span><br><span class="line">    freopen(<span class="string">"in.txt"</span>, <span class="string">"w+t"</span>, <span class="built_in">stdout</span>);</span><br><span class="line"><span class="comment">//    printf("%d\n", testcase);</span></span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        n = <span class="number">32</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d%c"</span>, rand(), i == n<span class="number">-1</span> ? <span class="string">'\n'</span> : <span class="string">' '</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        m = <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, m);</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; L;</span><br><span class="line">        L.push_back(n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> cmd = rand()%<span class="number">8</span>;</span><br><span class="line">                <span class="keyword">if</span> (n == <span class="number">1</span> &amp;&amp; cmd == <span class="number">2</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">0</span>) &#123;</span><br><span class="line">                	<span class="keyword">int</span> x = rand()%i;</span><br><span class="line">                	<span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, cmd, x);</span><br><span class="line">                	n = L[x];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">1</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%d %d %d\n"</span>, cmd, rand()%(n+<span class="number">1</span>), rand()), n++;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">2</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, cmd, rand()%n+<span class="number">1</span>), n--;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">3</span>) &#123;</span><br><span class="line">                    x = rand()%n+<span class="number">1</span>, y = rand()%n+<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (x &gt; y)  swap(x, y);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%d %d %d\n"</span>, cmd, x, y);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">4</span>) &#123;</span><br><span class="line">                    x = rand()%n+<span class="number">1</span>, y = rand()%n+<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (x &gt; y)  swap(x, y);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%d %d %d %d\n"</span>, cmd, x, y, rand());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cmd == <span class="number">5</span> || cmd == <span class="number">6</span> || cmd == <span class="number">7</span>) &#123;</span><br><span class="line">                    x = rand()%n+<span class="number">1</span>, y = rand()%n+<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (x &gt; y)  swap(x, y);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%d %d %d\n"</span>, cmd, x, y);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            L.push_back(n);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-poj-1151" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/05/poj-1151/" class="article-date">
  <time datetime="2015-06-05T01:03:50.000Z" itemprop="datePublished">2015-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/05/poj-1151/">POJ 1151 - Atlantis</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/05/poj-1151/" data-id="cimun1k6m005jn2xcbhd6wqcp" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/05/poj-1151/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/掃描線/">掃描線</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/矩形面積并/">矩形面積并</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/線段樹/">線段樹</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>給一堆平行兩軸的矩形，請問面積的聯集為何。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2</span><br><span class="line">10 10 20 20</span><br><span class="line">15 15 25 25.5</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Test case #1</span><br><span class="line">Total explored area: 180.00</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>利用掃描線算法，從 x 軸小掃描到大，維度 y 軸上的覆蓋情況。</p>
<p>若單純用離散方法在 2D 網格上填充，算法複雜度是 $O(n^2)$，最慘情況還會再增加到 $O(n^4)$，平均上來說離散方法是可行，但是記憶體是 $O(n^2)$。</p>
<p>由於 ITSA 的那題 n 會高達 30000，於是拿這一題來練手，掃描線算法複雜度 $O(n \log n)$，利用線段樹操作時，維護某個區間的完全覆蓋數，當完全覆蓋數等於 0 時，則計算子樹的覆蓋長度總和，雖然沒辦法完全覆蓋，則部分覆蓋可以從子樹計算得到。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">262144</span>;</span><br><span class="line"><span class="keyword">class</span> SegmentTree &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Node &#123;</span><br><span class="line">        <span class="keyword">int</span> cover;				<span class="comment">// #cover</span></span><br><span class="line">        <span class="keyword">double</span> L, R;			<span class="comment">// value in real line, cover [L, R]</span></span><br><span class="line">        <span class="keyword">double</span> clen;			<span class="comment">// cover length</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>, <span class="keyword">double</span> c = <span class="number">0</span>, <span class="keyword">double</span> d = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">            cover = a, L = b, R = c, clen = d;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; nodes[MAXN];</span><br><span class="line">    <span class="keyword">double</span> Y[MAXN];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushDown</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushUp</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nodes[k].cover &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            nodes[k].clen = nodes[k].R - nodes[k].L;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (l == r)</span><br><span class="line">                nodes[k].clen = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                nodes[k].clen = nodes[k&lt;&lt;<span class="number">1</span>].clen + nodes[k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].clen;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123; </span><br><span class="line">        nodes[k].init(<span class="number">0</span>, Y[l], Y[r+<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (l == r)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        build(k&lt;&lt;<span class="number">1</span>, l, mid);</span><br><span class="line">        build(k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r);</span><br><span class="line">        pushUp(k, l, r);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// operator, add</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addUpdate</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        nodes[k].cover += val;</span><br><span class="line">        <span class="keyword">if</span> (nodes[k].cover &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            nodes[k].clen = nodes[k].R - nodes[k].L;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (l == r)</span><br><span class="line">                nodes[k].clen = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                nodes[k].clen = nodes[k&lt;&lt;<span class="number">1</span>].clen + nodes[k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].clen;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= l &amp;&amp; r &lt;= y) &#123;</span><br><span class="line">            addUpdate(k, l, r, val);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pushDown(k, l, r);</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            add(k&lt;&lt;<span class="number">1</span>, l, mid, x, y, val);</span><br><span class="line">        <span class="keyword">if</span> (y &gt; mid)</span><br><span class="line">            add(k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r, x, y, val);</span><br><span class="line">        pushUp(k, l, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// query </span></span><br><span class="line">    <span class="keyword">double</span> r_sum;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">qinit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        r_sum = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= l &amp;&amp; r &lt;= y) &#123;</span><br><span class="line">            r_sum += nodes[k].clen;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        pushDown(k, l, r);</span><br><span class="line">        <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt;= mid)</span><br><span class="line">            query(k&lt;&lt;<span class="number">1</span>, l, mid, x, y);</span><br><span class="line">        <span class="keyword">if</span> (y &gt; mid)</span><br><span class="line">            query(k&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r, x, y);</span><br><span class="line">        pushUp(k, l, r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; tree;</span><br><span class="line"><span class="keyword">struct</span> Event &#123;</span><br><span class="line">    <span class="keyword">double</span> x, yl, yr;</span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    Event(<span class="keyword">double</span> a = <span class="number">0</span>, <span class="keyword">double</span> b = <span class="number">0</span>, <span class="keyword">double</span> c = <span class="number">0</span>, <span class="keyword">int</span> d = <span class="number">0</span>):</span><br><span class="line">    x(a), yl(b), yr(c), val(d) &#123;&#125;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Event &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x &lt; a.x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">double</span> Lx[<span class="number">32767</span>], Ly[<span class="number">32767</span>], Rx[<span class="number">32767</span>], Ry[<span class="number">32767</span>], K[<span class="number">32767</span>];</span><br><span class="line"><span class="keyword">int</span> N;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">areaCoverAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Event&gt; events;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; VY;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">double</span>, <span class="keyword">int</span>&gt; RY;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">double</span> x1, x2, y1, y2;</span><br><span class="line">        x1 = Lx[i], x2 = Rx[i];</span><br><span class="line">        y1 = Ly[i], y2 = Ry[i];</span><br><span class="line">        events.push_back(Event(x1, y1, y2,  <span class="number">1</span>));</span><br><span class="line">        events.push_back(Event(x2, y1, y2, <span class="number">-1</span>));</span><br><span class="line">        VY.push_back(y1), VY.push_back(y2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sort(events.begin(), events.end());</span><br><span class="line">    sort(VY.begin(), VY.end());	</span><br><span class="line">    VY.resize(unique(VY.begin(), VY.end()) - VY.begin());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; VY.size(); i++) &#123;</span><br><span class="line">        tree.Y[i] = VY[i];</span><br><span class="line">        RY[VY[i]] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    tree.build(<span class="number">1</span>, <span class="number">0</span>, VY.size()<span class="number">-2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> area = <span class="number">0</span>, prevX = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j; i &lt; events.size(); ) &#123;		</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            tree.qinit();</span><br><span class="line">            tree.query(<span class="number">1</span>, <span class="number">0</span>, VY.size()<span class="number">-2</span>, <span class="number">0</span>, VY.size()<span class="number">-2</span>);</span><br><span class="line">            area += (events[i].x - prevX) * tree.r_sum;</span><br><span class="line">        &#125;</span><br><span class="line">        j = i;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; events.size() &amp;&amp; events[j].x &lt;= events[i].x) &#123;</span><br><span class="line">            tree.add(<span class="number">1</span>, <span class="number">0</span>, VY.size()<span class="number">-2</span>, RY[events[j].yl], RY[events[j].yr] - <span class="number">1</span>, events[j].val);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        prevX = events[i].x;</span><br><span class="line">        i = j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> area;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;N) == <span class="number">1</span> &amp;&amp; N) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%lf %lf %lf %lf"</span>, &amp;Lx[i], &amp;Ly[i], &amp;Rx[i], &amp;Ry[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Test case #%d\n"</span>, ++cases);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Total explored area: %.2f\n"</span>, areaCoverAll());</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">2</span><br><span class="line">10 10 20 20</span><br><span class="line">15 15 25 25.5</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-obstacle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/05/mproblem-obstacle/" class="article-date">
  <time datetime="2015-06-05T00:27:14.000Z" itemprop="datePublished">2015-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/05/mproblem-obstacle/">[ACM 題目] 障礙物轉換</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/05/mproblem-obstacle/" data-id="cimun1k67004un2xc02xhpxhn" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/05/mproblem-obstacle/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Minkowski/">Minkowski</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/計算幾何/">計算幾何</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>在計算幾何領域中，機器人規劃路線是一個實用的議題， 由於機器人是一個有體積的物體，要避開其他的障礙物，障礙物碰撞計算會變得相當複雜。由於某 M 沒有學好這一部分，知道一種方法可以將地圖轉換，把機器人轉換成一個點，計算得到新的障礙物，如此一來就不用處理障礙物碰撞。</p>
<p><img src="http://i.imgur.com/7uApMKE.png" alt=""></p>
<p>從上圖中，一個箭頭型機器人要從左下角移動到右上角，假設不考慮物體可以旋轉，請問是否能移動過去。若把機器人當作一點看待，則必須將物體邊緣增加，變成中間那張圖 configuration space，只剩下一個點和數個多邊形障礙物。接著可以轉換成 visibility graph，把剩下的白色空間進行梯形剖分或者三角剖分，將區域表示成一個點，相鄰區域拉一條邊，就成 dual graph，就能套用一般的最短路徑算法，來協助機器人行走。</p>
<p>處理這問題對於某 M 過於困難，於是將問題更簡化些，只需要把中間那一張圖其中一個障礙物變化求出即可。</p>
<p><img src="http://i.imgur.com/jH2Rv4A.png" alt=""></p>
<p>現在給定一個凸多邊形障礙物以及移動凸多邊形，假設定位點在深黑色點方形部分，藉由貼著障礙物可以構出新的障礙物，請問新的障礙物為何？</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>第一行會有一個整數 $T$，表示有多少組測資。</p>
<p>每一組測資會包含兩個凸多邊形。第一行有一個整數 $N$ 表示移動凸多邊形的頂點數量，接下來會有 $N$ 行，每一行會有兩個整數 $x, y$ 表示頂點座標。在 $N+1$ 行之後，會有一個整數 $M$ 表示障礙物凸多邊形的頂點數量，接下來會有 $M$ 行，每一行會有兩個整數 $x, y$ 表示頂點座標。</p>
<ul>
<li>$2 &lt; N, M &lt; 512$</li>
<li>$-32767 &lt; x, y &lt; 32767$</li>
<li>假設定位點 (深黑色點方形部分) 都設在原點 (0, 0)。</li>
<li>輸入順序會按照順時針或逆時針給定。</li>
</ul>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2 </span><br><span class="line"></span><br><span class="line">5</span><br><span class="line">-1 -1</span><br><span class="line">-1 1</span><br><span class="line">0 3</span><br><span class="line">1 1</span><br><span class="line">1 -1</span><br><span class="line"></span><br><span class="line">4</span><br><span class="line">1 1</span><br><span class="line">8 2</span><br><span class="line">12 -1</span><br><span class="line">6 -4</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">-1 -4</span><br><span class="line">-1 1</span><br><span class="line">1 1</span><br><span class="line"></span><br><span class="line">5 </span><br><span class="line">1 0</span><br><span class="line">6 5</span><br><span class="line">10 5</span><br><span class="line">10 -3</span><br><span class="line">1 -3</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Case #1: 89.0</span><br><span class="line">Case #2: 115.5</span><br></pre></td></tr></table></figure>
<h2 id="Hint"><a href="#Hint" class="headerlink" title="Hint"></a>Hint</h2><p><img src="http://i.imgur.com/CsxzEEo.png" alt=""></p>
<p><img src="http://i.imgur.com/8KqjT4W.png" alt=""></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>可以用 $O(nm \log nm)$ 來完成此題，方法很簡單，先將機器人的圖形按照原點旋轉 180 度，接著將障礙物每一個頂點座標加上機器人的座標，總共會得到 $nm$ 的頂點，套用凸包算法求一次即可。</p>
<p>這一題應用 Minkowski Sum 來完成，對於兩個凸多邊形的 Minkowski Sum，可以在 $O(n+m)$ 時間內完成，將兩個凸包採用逆時針儲存，挑選最左，等價時抓下方 y 座標的點，可以知道新凸包的頂點一定是由兩個凸包的頂點<span>$A_i, B_j$</span><!-- Has MathJax --> 疊加而成，一開始抓到的左下方頂點疊加可以得到第一個頂點，接著要按照凸包順序求出，則比較<span>$(A_i, A_{i+1})$</span><!-- Has MathJax --> 和<span>$(B_j, B_{j+1})$</span><!-- Has MathJax --> 哪一個偏的角度小，就挑選哪一個往前推動 <code>i = i+1</code> 或者是 <code>j = j+1</code>。最後就能在 $O(n+m)$ 時間內完成。</p>
<p>假設不是凸多邊形，兩個簡單多邊形最慘會到 $O(n^2 m^2)$。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
    <article id="post-mproblem-k-dominate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/05/mproblem-k-dominate/" class="article-date">
  <time datetime="2015-06-05T00:17:11.000Z" itemprop="datePublished">2015-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/解題區/">解題區</a>►<a class="article-category-link" href="/categories/解題區/出題解題/">出題解題</a>
  </div>

  </div>
  <div class="article-inner ">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/05/mproblem-k-dominate/">[ACM 題目] 優勢商品</a>
    </h1>
  

      </header>
        
    <footer class="article-footer">
      <a data-url="http://morris821028.github.io/2015/06/05/mproblem-k-dominate/" data-id="cimun1k5w004gn2xcst56wlf2" class="article-share-link">Share</a>
      
        <a href="http://morris821028.github.io/2015/06/05/mproblem-k-dominate/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/資料庫/">資料庫</a></li></ul>

    </footer>
    <div class="article-entry article-index" itemprop="articleBody">
      
          
        
          <div class="toggle-content">
            <h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>一份產品有很多屬性，把每一個屬性當作一個維度，當成 $D$ 個維度的向量，當維度越多時絕對支配 (各方面都是最好的) 的機率就越低。若把 $D = 2$，就是在二維空間中的支配點 (Zerojudge d555 平面上的極大點)。由於絕對優勢的產品隨著維度增加而變少，定義出一種相對優勢產品，給定一個 $K$，若 $p_i$ 支配 (<em>k</em>-dominate) $p_j$，必須滿足下列三條：</p>
<ul>
<li>$\exists S’ \subseteq S, |S’| = K$</li>
<li>$\forall s_r \in S’, p_i.s_r \geq p_j.s_r $</li>
<li>$\exists s_t \in S’, p_i.s_t &gt; p_j.s_t$</li>
</ul>
<p>用中文解釋這幾條數學公式，假設有 6 個維度的產品，目標 $K = 5$，則表示要在 6 的維度中任意挑選 5 個維度比較，若存在一種挑法可以支配，則可以說 $p_i$ <em>k</em>-dominate $p_j$</p>
<p>例如現在有 8 台筆記型電腦，共有 6 種屬性可以比較，數值越大越好。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Notebook</th>
<th style="text-align:center">CPU</th>
<th style="text-align:center">RAM</th>
<th style="text-align:center">HDD</th>
<th style="text-align:center">HDD S.</th>
<th style="text-align:center">Q.</th>
<th style="text-align:center">VRAM</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$N_1$</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">5</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">$N_2$</td>
<td style="text-align:center">9</td>
<td style="text-align:center">4</td>
<td style="text-align:center">9</td>
<td style="text-align:center">7</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">$N_3$</td>
<td style="text-align:center">8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
<td style="text-align:center">2</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center">$N_4$</td>
<td style="text-align:center">5</td>
<td style="text-align:center">6</td>
<td style="text-align:center">8</td>
<td style="text-align:center">9</td>
<td style="text-align:center">5</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">$N_5$</td>
<td style="text-align:center">9</td>
<td style="text-align:center">7</td>
<td style="text-align:center">9</td>
<td style="text-align:center">6</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">$N_6$</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">5</td>
<td style="text-align:center">3</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">$N_7$</td>
<td style="text-align:center">5</td>
<td style="text-align:center">7</td>
<td style="text-align:center">3</td>
<td style="text-align:center">8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center">$N_8$</td>
<td style="text-align:center">4</td>
<td style="text-align:center">4</td>
<td style="text-align:center">8</td>
<td style="text-align:center">6</td>
<td style="text-align:center">6</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
<p>若要判斷 $N_2$ 是否支配 $N_3$，從中挑取 (CPU, RAM, HDD, HDD S., Q.) 這 5 個屬性比較，得到 $N_2$ 勝過於 $N_3$。最後可以發現到 $N_2$ 這產品可以支配 $N_1, N_3, N_5, N_6, N_8$。</p>
<p>現在問題來了，要找到不被任何產品支配的產品 (<em>k</em>-dominant skyline)。如上表 8 項產品的情況，只會有 $N_2, N_4$。</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>第一行會有一個整數 $T$ 表示有多少組測資。</p>
<p>每一組測資第一行會有三個整數 $N, D, K$，分別表示產品數量、產品屬性種類、以及支配比較的屬性種類。接下來會有 $N$ 行數據，每一行上會有 $D$ 個整數 $s_j$ 表示一個產品的屬性，產品按照輸入順序編號。</p>
<ul>
<li>$N &lt; 1024$</li>
<li>$0 &lt; D, K &lt; 8$</li>
<li>$0 &lt; s_j &lt; 1000$</li>
</ul>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>對於每組測資輸出一行，輸出該組測資所有的 <em>k</em>-dominant skyline 的產品編號，由小到大輸出。若不存在則輸出 <code>NONE</code>。</p>
<h2 id="Sample-Input"><a href="#Sample-Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">4</span><br><span class="line"></span><br><span class="line">2 3 1</span><br><span class="line">20 20 20</span><br><span class="line">20 20 20</span><br><span class="line"></span><br><span class="line">2 5 1</span><br><span class="line">20 5 20 20 20</span><br><span class="line">5 20 20 20 20</span><br><span class="line"></span><br><span class="line">4 6 5</span><br><span class="line">9 4 9 7 7 9</span><br><span class="line">9 7 9 6 5 4</span><br><span class="line">9 6 9 8 3 3</span><br><span class="line">1 2 3 9 2 2</span><br><span class="line"></span><br><span class="line">8 6 5</span><br><span class="line">3 3 5 6 6 8</span><br><span class="line">9 4 9 7 7 9</span><br><span class="line">8 4 7 9 2 7</span><br><span class="line">5 6 8 9 5 9</span><br><span class="line">9 7 9 6 2 4</span><br><span class="line">6 6 6 5 3 5</span><br><span class="line">5 7 3 8 4 6</span><br><span class="line">4 4 8 6 6 4</span><br></pre></td></tr></table></figure>
<h2 id="Sample-Output"><a href="#Sample-Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Case #1: 1 2</span><br><span class="line">Case #2: NONE</span><br><span class="line">Case #3: 1</span><br><span class="line">Case #4: 2 4</span><br></pre></td></tr></table></figure>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>這是一篇論文題目 <em>k</em>-dominant skyline set，網路上提出不少算法，看起來都是有容錯率。 </p>
<p>這一題只是介紹題，沒有強求高效算法計算，直接 $O(N^2)$ 的比較，稍微優化一下就可以。若要快一點，按照總和由大排到小，從概念上總和越大，表示支配別人的機率越高，那麼根據這種貪心思路去篩選，可以減少很多不必要的比較，速度會更快些。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAXN = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">int</span> N, D, K;</span><br><span class="line"><span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; C;</span><br><span class="line"><span class="keyword">struct</span> Product &#123;</span><br><span class="line">    <span class="keyword">int</span> v[<span class="number">8</span>], id;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(<span class="keyword">const</span> Product &amp;a) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sum() &gt; a.sum();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; D; i++)</span><br><span class="line">            s += v[i];</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">domain</span><span class="params">(Product &amp;u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;x : C) &#123;</span><br><span class="line">            <span class="keyword">int</span> h1 = <span class="number">1</span>, h2 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;e : x) &#123;</span><br><span class="line">                h1 &amp;= v[e] &gt;= u.v[e];</span><br><span class="line">                h2 |= v[e] &gt;  u.v[e];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (h1 &amp;&amp; h2)   <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; item[MAXN];</span><br><span class="line"><span class="keyword">int</span> used[MAXN];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testcase, cases = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;testcase);</span><br><span class="line">    <span class="keyword">while</span> (testcase--) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d %d %d"</span>, &amp;N, &amp;D, &amp;K);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; D; j++)</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;item[i].v[j]);</span><br><span class="line">            item[i].id = i;</span><br><span class="line">        &#125;</span><br><span class="line">        sort(item, item+N);</span><br><span class="line">        </span><br><span class="line">        C.clear();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">1</span>&lt;&lt;D); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (__builtin_popcount(i) == K) &#123;</span><br><span class="line">                <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; A;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; D; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((i&gt;&gt;j)&amp;<span class="number">1</span>)</span><br><span class="line">                        A.push_back(j);</span><br><span class="line">                &#125;</span><br><span class="line">                C.push_back(A);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">vector</span>&lt;Product&gt; filter;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; ret;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">            used[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                filter.push_back(item[i]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; N; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (used[j] == <span class="number">0</span> &amp;&amp; item[i].domain(item[j]))</span><br><span class="line">                        used[j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filter.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> ok = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N &amp;&amp; ok; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (item[j].domain(filter[i]))</span><br><span class="line">                    ok = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ok == <span class="number">1</span>)</span><br><span class="line">                ret.push_back(filter[i].id);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sort(ret.begin(), ret.end());</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Case #%d:"</span>, ++cases);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ret.size(); i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" %d"</span>, ret[i]+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(ret.size() ? <span class="string">""</span> : <span class="string">" NONE"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          </div>
          <div class="toggle-input article-more-link"><a>Read More +</a></div>
        
      
    </div>

  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/categories/解題區/page/8/">&laquo; Prev</a><a class="page-number" href="/categories/解題區/">1</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/7/">7</a><a class="page-number" href="/categories/解題區/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/categories/解題區/page/10/">10</a><a class="page-number" href="/categories/解題區/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/categories/解題區/page/60/">60</a><a class="extend next" rel="next" href="/categories/解題區/page/10/">Next &raquo;</a>
    </nav>
  
</section>
          
            <aside id="sidebar">
  <div id="ukagaka_panel"></div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/">學校課程</a><span class="category-list-count">73</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/介面設計/">介面設計</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/作業系統/">作業系統</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/即時系統/">即時系統</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/大學專題/">大學專題</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/巨量資料/">巨量資料</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/平行程式/">平行程式</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/敏捷方法/">敏捷方法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/數位影像生成/">數位影像生成</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/編譯器/">編譯器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/自然語言/">自然語言</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/虛擬實境/">虛擬實境</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算型智慧/">計算型智慧</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/計算幾何/">計算幾何</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資料庫系統/">資料庫系統</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/資訊安全/">資訊安全</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/學校課程/通識課程/">通識課程</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/手札日記/">手札日記</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/">網頁設計</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/About-This-Blog/">About This Blog</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/HTML5/">HTML5</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/JQuery/">JQuery</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/網頁設計/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/">解題區</a><span class="category-list-count">599</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/Latex/">Latex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/出題解題/">出題解題</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-POJ/">解題區 - POJ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-UVa/">解題區 - UVa</a><span class="category-list-count">463</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-Zerojudge/">解題區 - Zerojudge</a><span class="category-list-count">76</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-其他題目/">解題區 - 其他題目</a><span class="category-list-count">37</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/解題區/解題區-未解題目/">解題區 - 未解題目</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/雜言筆記/">雜言筆記</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a class="text" href="/2016/04/10/2016-google-code-jam-qr/">
              
                <i class="icon-file-o"></i> 
              
            2016 Google Code Jam Round QR</a>
          </li>
        
          <li>
            <a class="text" href="/2016/03/23/parallel-skill-interval-partitioning/">
              
                <i class="icon-file-o"></i> 
              
            數據分割 區間分塊小技巧</a>
          </li>
        
          <li>
            <a class="text" href="/2016/03/16/jg-10085/">
              
                <i class="icon-file-o"></i> 
              
            批改娘 10085. Parallel Count (debug)</a>
          </li>
        
          <li>
            <a class="text" href="/2016/03/16/jg-10084/">
              
                <i class="icon-file-o"></i> 
              
            批改娘 10084. Prefix Sum (pthread)</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/29/uva-13006/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13006 - Cake cut</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/29/uva-13010/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13010 - Galactic taxes</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/29/uva-13014/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13014 - Keep it energized</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/08/uva-13054/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13054 - Hippo Circus</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/08/uva-13032/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13032 - Marbles in Jars</a>
          </li>
        
          <li>
            <a class="text" href="/2016/02/02/uva-13038/">
              
                <i class="icon-file-o"></i> 
              
            UVa 13038 - Directed Forest</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">   
      	<ul>
	      <li><a href="http://mypaper.pchome.com.tw/zerojudge" target="_blank" title="Old Blog"><i class="icon-star"></i> Morris' Blog (pchome)</a></li>
	      <li><a href="http://flere114.blogspot.tw/" target="_blank" title="蘿莉勿觸"><i class="icon-googles"></i> flere's Blog</a></li>
	      <li><a href="http://dreamoon4.blogspot.tw/" target="_blank" title="夢月"><i class="icon-googles"></i> dreamoon's Blog</a></li>
	      <li><a href="http://m80126colin.github.io" target="_blank" title="許胖們"><i class="icon-github-alt"></i> m80126colin's Blog</a></li>
	      <li><a href="http://sd12582000.blogspot.tw/" target="_blank" title="妮可妮可"><i class="icon-github-alt"></i> Nico's Blog</a></li>
	      <li><a href="http://kuoe0.logdown.com/" target="_blank" title="郭至軒大神"><i class="icon-github-alt"></i> KuoE0's Dots</a></li>
	      <li><a href="http://tyan.io/" title=""><i class="icon-github-alt"></i> Tyan Blog</a></li>
    	</ul>
    </div>
</div>

  
    
<script src="/js/jquery-ui.js"></script>
<script src="/js/ukagaka/jquery.morris.ukagaka.resource.js"></script>
<script src="/js/ukagaka/typed.js"></script>
<script type="text/javascript">
  $('#ukagaka_panel').ukagaka();
</script>
  
</aside>
          
        
      </div>
      <footer id="footer">
  
  <div class="outer">    
    <div class="social-group">
      
      <a href="https://github.com/morris821028" target="_blank" title="github"><i class="icon-github"></i></a>
      
      
      <a href="https://plus.google.com/u/0/108158678174364359204" target="_blank" title="Google+"><i class="icon-google-plus-sign"></i></a>
      
      
      <a href="https://www.facebook.com/Morris1028" target="_blank" title="facebook"><i class="icon-facebook-sign"></i></a>
      
      
      <a href="http://uhunt.felix-halim.net/id/46705" target="_blank" title="uhunt" ><span class="icon-uhunt">UVa<span></a>
      
    </div>
    <div id="footer-info" class="inner">
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/morris821028/hexo-theme-landscape" target="_blank" title="landscape">landscape</a> &copy; 2016 Shiang-Yun Yang 
    </div>  

  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link"><i class=icon-home ></i>&nbsp&nbspHome</a>
  
    <a href="/about" class="mobile-nav-link"><i class=icon-user ></i>&nbsp&nbspAbout</a>
  
    <a href="/archives" class="mobile-nav-link"><i class=icon-archive ></i>&nbsp&nbspArchives</a>
  
    <a href="/tags" class="mobile-nav-link"><i class=icon-tags ></i>&nbsp&nbspTags</a>
  
    <a href="/picture" class="mobile-nav-link"><i class=icon-camera ></i>&nbsp&nbspPictures</a>
  
    <a href="/works" class="mobile-nav-link"><i class=icon-trophy ></i>&nbsp&nbspWorks</a>
  
</nav>
    
<script>
  var disqus_shortname = 'morris1028';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/jquery.lazyload.js"></script>
<script src="/js/jquery.als-1.6.js"></script>

<script src="/js/script.js"></script>

  </div>

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>